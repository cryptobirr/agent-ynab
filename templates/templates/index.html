<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YNAB Transaction Tagger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            border: 1px solid #3a3a3a;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 10px;
        }

        header p {
            color: #b0b0b0;
        }

        .toolbar {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            border: 1px solid #3a3a3a;
        }

        .toolbar button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .toolbar button:hover {
            background-color: #2980b9;
        }

        .toolbar button.submit {
            background-color: #27ae60;
        }

        .toolbar button.submit:hover {
            background-color: #229954;
        }

        .toolbar input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 14px;
            width: 250px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        .toolbar select {
            padding: 8px 12px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 14px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        .toolbar label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .stats {
            background-color: #1a1a1a;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 14px;
            margin-left: auto;
            border: 1px solid #444;
            color: #b0b0b0;
        }

        /* Account Tabs */
        .account-tabs {
            background-color: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid #3a3a3a;
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid #3a3a3a;
            overflow-x: auto;
        }

        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #888;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-button:hover {
            background-color: #333;
            color: #e0e0e0;
        }

        .tab-button.active {
            color: #5dade2;
            border-bottom-color: #5dade2;
        }

        .tab-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background-color: #e74c3c;
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .tab-badge.zero {
            background-color: #27ae60;
        }

        /* Category Selector Modal */
        .category-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 1000;
        }

        .category-modal {
            background: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            max-height: 600px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid #444;
        }

        .category-modal-header {
            border-bottom: 1px solid #444;
            padding: 16px;
        }

        .category-modal-selected {
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .category-modal-current {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-modal-current .checkmark {
            color: #27ae60;
            font-weight: bold;
        }

        .category-search-container {
            padding: 12px 16px;
            border-bottom: 1px solid #444;
            background-color: #1a1a1a;
        }

        .category-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            outline: none;
            transition: border-color 0.2s;
            background-color: #2a2a2a;
            color: #e0e0e0;
        }

        .category-search-input:focus {
            border-color: #5dade2;
            box-shadow: 0 0 0 3px rgba(93, 173, 226, 0.2);
        }

        .category-modal-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid #444;
        }

        .category-action-button {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-action-button:hover {
            background-color: #333;
            border-color: #5dade2;
        }

        .category-modal-body {
            overflow-y: auto;
            max-height: 400px;
            flex: 1;
        }

        .category-group {
            border-bottom: 1px solid #333;
        }

        .category-group-header {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            background-color: #1a1a1a;
        }

        .category-item {
            padding: 12px 16px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #e0e0e0;
        }

        .category-item:hover {
            background-color: #333;
        }

        .category-item .checkmark {
            color: #27ae60;
            font-weight: bold;
        }

        /* Split Transaction Modal */
        .split-modal {
            background: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 1200px;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid #444;
        }

        .split-modal-header {
            padding: 12px 16px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1a1a1a;
        }

        .split-modal-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .split-total {
            font-size: 13px;
            color: #666;
        }

        .split-modal-body {
            padding: 12px 16px;
            overflow-y: auto;
            flex: 1;
            background-color: #1a1a1a;
        }

        .split-row {
            display: grid;
            grid-template-columns: 1.2fr 1.8fr 2fr 1fr 1fr;
            gap: 6px;
            margin-bottom: 6px;
            align-items: center;
        }

        .split-payee-select,
        .split-category-select,
        .split-memo-input,
        .split-outflow-input,
        .split-inflow-input {
            padding: 6px 8px;
            border: 1px solid #444;
            border-radius: 3px;
            font-size: 13px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            height: 32px;
        }

        .split-payee-select:focus,
        .split-category-select:focus,
        .split-memo-input:focus,
        .split-outflow-input:focus,
        .split-inflow-input:focus {
            outline: none;
            border-color: #5dade2;
            box-shadow: 0 0 0 2px rgba(93, 173, 226, 0.2);
        }

        .add-split-button {
            margin-top: 8px;
            padding: 6px 12px;
            border: 1px solid #5dade2;
            border-radius: 3px;
            background-color: #1a1a1a;
            color: #5dade2;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .add-split-button:hover {
            background-color: #333;
        }

        .split-modal-footer {
            padding: 12px 16px;
            border-top: 1px solid #444;
            background-color: #1a1a1a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .split-remaining {
            font-size: 13px;
            color: #b0b0b0;
            display: flex;
            gap: 16px;
        }

        .split-remaining-label {
            font-weight: 500;
        }

        .split-remaining-amounts {
            display: flex;
            gap: 12px;
        }

        .split-modal-actions {
            display: flex;
            gap: 8px;
        }

        .split-cancel-button,
        .split-save-button {
            padding: 8px 16px;
            border: 1px solid #444;
            border-radius: 3px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .split-cancel-button {
            background-color: #1a1a1a;
            color: #b0b0b0;
        }

        .split-cancel-button:hover {
            background-color: #333;
        }

        .split-save-button {
            background-color: #5dade2;
            color: #1a1a1a;
            border-color: #5dade2;
        }

        .split-save-button:hover {
            background-color: #4a9dd1;
        }

        .category-button {
            padding: 8px 16px;
            border: 1px solid #444;
            background: #2a2a2a;
            color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            width: 100%;
            transition: all 0.2s;
        }

        .category-button:hover {
            border-color: #5dade2;
            background-color: #333;
        }

        .category-button.uncategorized {
            background-color: #3d3416;
            border-color: #d4a017;
            color: #f0d090;
        }

        .category-button.transfer {
            background-color: #2a2a2a;
            border-color: #555;
            color: #888;
            cursor: not-allowed;
            font-style: italic;
        }

        .category-button.transfer:hover {
            background-color: #2a2a2a;
            border-color: #555;
        }

        .category-button.inflow {
            background-color: #1a3a1a;
            border-color: #2d5a2d;
            color: #7ec87e;
            cursor: not-allowed;
            font-weight: 500;
        }

        .category-button.inflow:hover {
            background-color: #1a3a1a;
            border-color: #2d5a2d;
        }

        /* AI Suggestion Badges */
        .ai-badge {
            display: inline-block;
            margin-left: 6px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .ai-badge.sop {
            background-color: #27ae60;
            color: white;
        }

        .ai-badge.historical {
            background-color: #3498db;
            color: white;
        }

        .ai-badge.research {
            background-color: #e74c3c;
            color: white;
        }

        .confidence-indicator {
            display: inline-block;
            margin-left: 4px;
            font-size: 10px;
            color: #7f8c8d;
        }

        .tab-button.active .tab-badge {
            background-color: #3498db;
        }

        .tab-button.active .tab-badge.zero {
            background-color: #27ae60;
        }

        .transaction-grid {
            background-color: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            overflow-x: auto;
            border: 1px solid #3a3a3a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: #1a1a1a;
            color: #e0e0e0;
            position: sticky;
            top: 0;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background-color: #222;
        }

        th.sortable::after {
            content: ' ↕';
            opacity: 0.5;
        }

        th.sorted-asc::after {
            content: ' ↑';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' ↓';
            opacity: 1;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #3a3a3a;
        }

        tr:hover {
            background-color: #333;
        }

        tr.selected {
            background-color: #2a4a5a;
        }

        .memo {
            font-size: 12px;
            color: #888;
            font-style: italic;
            max-width: 200px;
        }

        .memo-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid transparent;
            background: transparent;
            color: #888;
            font-size: 12px;
            font-style: italic;
            font-family: inherit;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .memo-input:hover {
            border-color: #444;
            background-color: #1a1a1a;
        }

        .memo-input:focus {
            outline: none;
            border-color: #5dade2;
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-style: normal;
        }

        .memo-input::placeholder {
            color: #555;
            font-style: italic;
        }

        .amount {
            text-align: right;
            font-weight: 600;
        }

        .amount.positive {
            color: #5ec85e;
        }

        .amount.negative {
            color: #ff6b6b;
        }

        select.category-selector {
            padding: 6px 10px;
            border: 1px solid #444;
            border-radius: 4px;
            width: 200px;
            font-size: 13px;
            background-color: #2a2a2a;
            color: #e0e0e0;
        }

        select.category-selector.uncategorized {
            border-color: #ff6b6b;
            background-color: #3a1a1a;
        }

        input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background-color: #1a3a1a;
            color: #7ec87e;
            border: 1px solid #2d5a2d;
        }

        .message.error {
            background-color: #3a1a1a;
            color: #ff9999;
            border: 1px solid #5a2d2d;
        }

        .message.info {
            background-color: #1a2a3a;
            color: #7eb8e0;
            border: 1px solid #2d4a5a;
        }

        .message.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: #888;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar input[type="text"],
            .toolbar select {
                width: 100%;
            }

            .stats {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>YNAB Transaction Tagger</h1>
            <p>Review and categorize your transactions with AI-powered suggestions</p>
        </header>

        <div id="message" class="message"></div>

        <div class="toolbar">
            <button id="loadBtn" onclick="loadTransactions()">Load Transactions</button>
            <button id="submitBtn" class="submit" onclick="submitTransactions()">Submit Tagged</button>
            
            <input type="text" id="searchInput" placeholder="Search by payee..." onkeyup="applyFilters()">
            
            <select id="sortSelect" onchange="applySort()">
                <option value="">Sort by...</option>
                <option value="date-desc">Date (Newest)</option>
                <option value="date-asc">Date (Oldest)</option>
                <option value="account_name-asc">Account (A-Z)</option>
                <option value="account_name-desc">Account (Z-A)</option>
                <option value="amount-desc">Amount (High to Low)</option>
                <option value="amount-asc">Amount (Low to High)</option>
                <option value="payee_name-asc">Payee (A-Z)</option>
                <option value="payee_name-desc">Payee (Z-A)</option>
                <option value="category_name-asc">Category (A-Z)</option>
                <option value="category_name-desc">Category (Z-A)</option>
                <option value="memo-asc">Memo (A-Z)</option>
                <option value="memo-desc">Memo (Z-A)</option>
            </select>
            
            <label>
                <input type="checkbox" id="uncategorizedFilter" onchange="applyFilters()">
                Show Uncategorized Only
            </label>
            
            <div class="stats" id="stats">
                <span id="statsText">No transactions loaded</span>
            </div>
        </div>

        <div class="account-tabs" id="accountTabs" style="display: none;">
            <div class="tabs-header" id="tabsHeader">
                <!-- Tabs will be dynamically generated here -->
            </div>
        </div>

        <div class="transaction-grid">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th class="sortable" onclick="sortBy('date')">Date</th>
                        <th class="sortable" onclick="sortBy('account_name')">Account</th>
                        <th class="sortable" onclick="sortBy('payee_name')">Payee</th>
                        <th class="sortable" onclick="sortBy('memo')">Memo</th>
                        <th class="sortable" onclick="sortBy('category_name')">Category</th>
                        <th class="sortable" onclick="sortBy('amount')">Amount</th>
                    </tr>
                </thead>
                <tbody id="transactionTableBody">
                    <tr>
                        <td colspan="7" class="loading">Click "Load Transactions" to begin</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Global state
        let transactions = [];
        let filteredTransactions = [];
        let categories = [];
        let currentSort = null;
        let accounts = [];
        let currentAccount = 'all';
        let categoryGroups = [];
        let currentModalTransactionIndex = null;
        let budgetId = null;  // Store budget_id for submissions

        // Show message to user
        function showMessage(text, type = 'info') {
            const msgEl = document.getElementById('message');
            msgEl.textContent = text;
            msgEl.className = `message ${type} show`;
            setTimeout(() => msgEl.classList.remove('show'), 5000);
        }

        // Load transactions from API
        async function loadTransactions() {
            const loadBtn = document.getElementById('loadBtn');
            loadBtn.disabled = true;
            loadBtn.textContent = 'Loading...';
            
            try {
                // Force no-cache on fetch request
                const response = await fetch('/api/load-and-tag', {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();
                
                if (result.status === 'error') {
                    throw new Error(result.message);
                }

                // Extract transactions from all budgets
                transactions = [];
                categories = [];
                categoryGroups = [];  // CLEAR categoryGroups too!
                const budgets = result.data.budgets || {};

                // DEBUG: Log what we received
                console.log('=== API RESPONSE DEBUG ===');
                console.log('Budgets received:', Object.keys(budgets));

                // Collect all accounts from all budgets
                let all_accounts = [];

                for (const budgetKey in budgets) {
                    const budget = budgets[budgetKey];
                    console.log(`${budgetKey} transactions:`, budget.transactions?.length || 0);

                    // Log first 3 transaction payees for verification
                    if (budget.transactions) {
                        budget.transactions.slice(0, 3).forEach(t => {
                            console.log(`  - ${t.date}: ${t.payee_name} (transfer_account_id: ${t.transfer_account_id || 'null'})`);
                        });
                    }

                    // Store budget_id (use first budget's ID)
                    if (!budgetId && budget.budget_id) {
                        budgetId = budget.budget_id;
                    }

                    if (budget.transactions) {
                        transactions.push(...budget.transactions);
                    }
                    if (budget.category_groups) {
                        categoryGroups.push(...budget.category_groups);
                    }

                    // Collect all_accounts from this budget
                    if (budget.all_accounts) {
                        all_accounts.push(...budget.all_accounts);
                    }
                }

                console.log('Total transactions loaded:', transactions.length);
                console.log('=========================')
                if (all_accounts.length > 0) {
                    accounts = all_accounts.map(acc => ({ id: acc.id, name: acc.name }));
                } else {
                    // Fallback: Extract from transactions
                    const accountMap = new Map();
                    transactions.forEach(txn => {
                        if (txn.account_id && txn.account_name) {
                            accountMap.set(txn.account_id, txn.account_name);
                        }
                    });
                    accounts = Array.from(accountMap, ([id, name]) => ({ id, name }));
                }

                // Always show account tabs if there are multiple accounts
                if (accounts.length > 0) {
                    createAccountTabs();
                    document.getElementById('accountTabs').style.display = 'block';
                } else {
                    document.getElementById('accountTabs').style.display = 'none';
                }

                filteredTransactions = [...transactions];
                applyAccountFilter();
                renderTransactions();
                updateStats();
                showMessage(`Loaded ${transactions.length} transactions`, 'success');
                
            } catch (error) {
                showMessage(`Error loading transactions: ${error.message}`, 'error');
                console.error('Load error:', error);
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'Load Transactions';
            }
        }

        // Create account tabs dynamically
        function createAccountTabs() {
            const tabsHeader = document.getElementById('tabsHeader');
            tabsHeader.innerHTML = '';

            // Add "All Accounts" tab
            const allCount = transactions.length;
            const allTab = document.createElement('button');
            allTab.className = 'tab-button' + (currentAccount === 'all' ? ' active' : '');
            const allBadgeClass = allCount === 0 ? 'tab-badge zero' : 'tab-badge';
            allTab.innerHTML = `All Accounts<span class="${allBadgeClass}">${allCount}</span>`;
            allTab.onclick = () => switchAccount('all');
            tabsHeader.appendChild(allTab);

            // Add tab for each account (showing 0 for accounts with no transactions)
            accounts.forEach(account => {
                const count = transactions.filter(t => t.account_id === account.id).length;
                const tab = document.createElement('button');
                tab.className = 'tab-button' + (currentAccount === account.id ? ' active' : '');
                const badgeClass = count === 0 ? 'tab-badge zero' : 'tab-badge';
                tab.innerHTML = `${escapeHtml(account.name)} <span class="${badgeClass}">${count}</span>`;
                tab.onclick = () => switchAccount(account.id);
                tabsHeader.appendChild(tab);
            });
        }

        // Switch to a different account tab
        function switchAccount(accountId) {
            currentAccount = accountId;
            createAccountTabs();  // Refresh tabs to update active state
            applyAccountFilter();
            applyFilters();
        }

        // Filter transactions by current account
        function applyAccountFilter() {
            if (currentAccount === 'all') {
                filteredTransactions = [...transactions];
            } else {
                filteredTransactions = transactions.filter(t => t.account_id === currentAccount);
            }
        }

        // Render transactions to table
        function renderTransactions() {
            const tbody = document.getElementById('transactionTableBody');
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No transactions to display</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredTransactions.map((txn, idx) => {
                // Check if this is a transfer (YNAB standard behavior)
                const isTransfer = txn.category_name === 'SKIP_TRANSFER';
                // Check if this is an inflow (YNAB standard: inflows go to "Ready to Assign")
                const isInflow = txn.category_name === 'INFLOW_READY_TO_ASSIGN';

                let categoryText = '-- Select Category --';
                if (isTransfer) {
                    categoryText = 'Category not needed';
                } else if (isInflow) {
                    categoryText = 'Inflow: Ready to Assign';
                } else if (txn.category_group_name && txn.category_name) {
                    categoryText = `${txn.category_group_name}:${txn.category_name}`;
                } else if (txn.category_name) {
                    categoryText = txn.category_name;
                }

                // Build AI suggestion badges (not shown for transfers or inflows)
                let aiBadges = '';
                if (!isTransfer && !isInflow && txn.tier) {
                    const tierLabels = {
                        'sop': 'SOP',
                        'historical': 'AI',
                        'research': 'Manual'
                    };
                    aiBadges += `<span class="ai-badge ${txn.tier}">${tierLabels[txn.tier] || txn.tier}</span>`;

                    if (txn.confidence !== undefined) {
                        const confidencePct = Math.round(txn.confidence * 100);
                        aiBadges += `<span class="confidence-indicator">${confidencePct}%</span>`;
                    }
                }

                return `
                    <tr class="${txn.selected ? 'selected' : ''}" data-index="${idx}" title="${txn.reasoning || ''}">
                        <td><input type="checkbox" ${txn.selected ? 'checked' : ''} onchange="toggleTransaction(${idx})"></td>
                        <td>${formatDate(txn.date)}</td>
                        <td>${escapeHtml(txn.account_name || 'Unknown')}</td>
                        <td>${escapeHtml(txn.payee_name)}</td>
                        <td class="memo">
                            <input type="text"
                                class="memo-input"
                                value="${escapeHtml(txn.memo || '')}"
                                placeholder="Add memo..."
                                onchange="updateMemo(${idx}, this.value)"
                                onclick="event.stopPropagation()">
                        </td>
                        <td>
                            <button class="category-button ${isTransfer ? 'transfer' : isInflow ? 'inflow' : !txn.category_id ? 'uncategorized' : ''}"
                                    ${isTransfer || isInflow ? 'disabled' : `onclick="openTransactionModal(${idx})"`}>
                                ${escapeHtml(categoryText)}${aiBadges}
                            </button>
                        </td>
                        <td class="amount ${txn.amount >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(txn.amount)}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update memo for transaction
        function updateMemo(index, newMemo) {
            if (index >= 0 && index < filteredTransactions.length) {
                filteredTransactions[index].memo = newMemo;
                // Also update in main transactions array
                const txnId = filteredTransactions[index].id;
                const mainIndex = transactions.findIndex(t => t.id === txnId);
                if (mainIndex !== -1) {
                    transactions[mainIndex].memo = newMemo;
                }
            }
        }

        // Open appropriate modal (split if has subtransactions, otherwise category)
        function openTransactionModal(index) {
            const txn = filteredTransactions[index];

            // If transaction has subtransactions, open split modal
            if (txn.subtransactions && txn.subtransactions.length > 0) {
                openSplitModal(index);
            } else {
                openCategoryModal(index);
            }
        }

        // Open category selector modal
        function openCategoryModal(index) {
            currentModalTransactionIndex = index;
            const txn = filteredTransactions[index];

            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'category-modal-overlay';
            overlay.id = 'categoryModalOverlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) closeCategoryModal();
            };

            // Get current category display text
            let currentCategoryText = 'Select a category...';
            if (txn.category_group_name && txn.category_name) {
                currentCategoryText = `${txn.category_group_name}:${txn.category_name}`;
            } else if (txn.category_name) {
                currentCategoryText = txn.category_name;
            }

            // Build modal HTML
            overlay.innerHTML = `
                <div class="category-modal" onclick="event.stopPropagation()">
                    <div class="category-modal-header">
                        <div class="category-modal-selected">Selected</div>
                        <div class="category-modal-current">
                            <span class="checkmark">✓</span>
                            <span>${escapeHtml(currentCategoryText)}</span>
                        </div>
                    </div>
                    <div class="category-search-container">
                        <input
                            type="text"
                            id="categorySearchInput"
                            class="category-search-input"
                            placeholder="Search categories..."
                            oninput="filterCategories(this.value)"
                        />
                    </div>
                    <div class="category-modal-actions">
                        <button class="category-action-button" onclick="event.stopPropagation(); openPaymentTransferModal(${index})">
                            Payment/Transfer
                        </button>
                        <button class="category-action-button" onclick="event.stopPropagation(); openSplitModal(${index})">
                            Split
                        </button>
                    </div>
                    <div class="category-modal-body" id="categoryModalBody">
                        ${categoryGroups.map(group => `
                            <div class="category-group" data-group-name="${escapeHtml(group.name)}">
                                <div class="category-group-header">${escapeHtml(group.name)}</div>
                                ${group.categories.map(cat => `
                                    <button class="category-item"
                                        data-category-id="${cat.id}"
                                        data-category-name="${escapeHtml(cat.name)}"
                                        data-category-group="${escapeHtml(group.name)}"
                                        onclick="selectCategoryFromModal(this)">
                                        <span>${escapeHtml(cat.name)}</span>
                                        ${txn.category_id === cat.id ? '<span class="checkmark">✓</span>' : ''}
                                    </button>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Focus the search input
            setTimeout(() => {
                document.getElementById('categorySearchInput')?.focus();
            }, 100);
        }

        // Close category modal
        function closeCategoryModal() {
            const overlay = document.getElementById('categoryModalOverlay');
            if (overlay) {
                overlay.remove();
            }
            currentModalTransactionIndex = null;
        }

        // Filter categories based on search term
        function filterCategories(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            const categoryGroups = document.querySelectorAll('.category-group');

            categoryGroups.forEach(group => {
                const groupName = group.getAttribute('data-group-name').toLowerCase();
                const categoryItems = group.querySelectorAll('.category-item');
                let hasVisibleCategory = false;

                categoryItems.forEach(item => {
                    const categoryName = item.getAttribute('data-category-name').toLowerCase();
                    const matches = categoryName.includes(term) || groupName.includes(term);

                    item.style.display = matches ? 'flex' : 'none';
                    if (matches) hasVisibleCategory = true;
                });

                // Hide group if no categories match
                group.style.display = hasVisibleCategory ? 'block' : 'none';
            });
        }

        // Select a category from modal (using data attributes)
        function selectCategoryFromModal(button) {
            const categoryId = button.getAttribute('data-category-id');
            const categoryName = button.getAttribute('data-category-name');
            const categoryGroupName = button.getAttribute('data-category-group');

            if (currentModalTransactionIndex !== null) {
                filteredTransactions[currentModalTransactionIndex].category_id = categoryId;
                filteredTransactions[currentModalTransactionIndex].category_name = categoryName;
                filteredTransactions[currentModalTransactionIndex].category_group_name = categoryGroupName;
                renderTransactions();
                updateStats();
            }
            closeCategoryModal();
        }

        // Legacy function - keeping for backward compatibility
        function selectCategory(categoryId, categoryName, categoryGroupName) {
            if (currentModalTransactionIndex !== null) {
                filteredTransactions[currentModalTransactionIndex].category_id = categoryId;
                filteredTransactions[currentModalTransactionIndex].category_name = categoryName;
                filteredTransactions[currentModalTransactionIndex].category_group_name = categoryGroupName;
                renderTransactions();
                updateStats();
            }
            closeCategoryModal();
        }

        // Open Payment/Transfer modal
        function openPaymentTransferModal(index) {
            closeCategoryModal();
            const txn = filteredTransactions[index];
            const isInflow = txn.amount > 0;

            const overlay = document.createElement('div');
            overlay.className = 'category-modal-overlay';
            overlay.id = 'paymentTransferModalOverlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) closePaymentTransferModal();
            };

            const title = isInflow ? 'Payment from' : 'Transfer to';

            overlay.innerHTML = `
                <div class="category-modal" onclick="event.stopPropagation()">
                    <div class="category-modal-header">
                        <div class="category-modal-selected">${title}</div>
                    </div>
                    <div class="category-modal-body" id="paymentTransferModalBody">
                        ${accounts.map(account => `
                            <button class="category-item" onclick="event.stopPropagation(); selectPaymentTransfer('${account.id}', '${escapeHtml(account.name)}', ${index})">
                                <span>${escapeHtml(account.name)}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
        }

        // Close Payment/Transfer modal
        function closePaymentTransferModal() {
            const overlay = document.getElementById('paymentTransferModalOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Select Payment/Transfer account
        function selectPaymentTransfer(accountId, accountName, index) {
            // Mark as transfer in YNAB
            filteredTransactions[index].transfer_account_id = accountId;
            filteredTransactions[index].category_name = 'SKIP_TRANSFER';
            filteredTransactions[index].payee_name = `Transfer: ${accountName}`;
            renderTransactions();
            updateStats();
            closePaymentTransferModal();
        }

        // Open Split modal
        function openSplitModal(index) {
            closeCategoryModal();
            const txn = filteredTransactions[index];

            const overlay = document.createElement('div');
            overlay.className = 'category-modal-overlay';
            overlay.id = 'splitModalOverlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) closeSplitModal();
            };

            // Generate split rows HTML
            const existingSplits = txn.subtransactions || [];
            let splitRowsHTML = '';

            if (existingSplits.length > 0) {
                // Load existing splits
                splitRowsHTML = existingSplits.map(sub => {
                    const amount = Math.abs(sub.amount) / 1000;
                    const isOutflow = sub.amount < 0;
                    return `
                        <div class="split-row">
                            <select class="split-payee-select">
                                <option value="">payee</option>
                            </select>
                            <select class="split-category-select">
                                <option value="">category</option>
                                ${categoryGroups.map(group => `
                                    <optgroup label="${escapeHtml(group.name)}">
                                        ${group.categories.map(cat => `
                                            <option value="${cat.id}" ${cat.id === sub.category_id ? 'selected' : ''}>${escapeHtml(group.name)}:${escapeHtml(cat.name)}</option>
                                        `).join('')}
                                    </optgroup>
                                `).join('')}
                            </select>
                            <input type="text" class="split-memo-input" placeholder="memo" value="${escapeHtml(sub.memo || '')}" />
                            <input type="number" class="split-outflow-input" placeholder="outflow" step="0.01" value="${isOutflow ? amount.toFixed(2) : ''}" />
                            <input type="number" class="split-inflow-input" placeholder="inflow" step="0.01" value="${!isOutflow ? amount.toFixed(2) : ''}" />
                        </div>
                    `;
                }).join('');
            } else {
                // Create two empty rows for new split
                splitRowsHTML = `
                    <div class="split-row">
                        <select class="split-payee-select">
                            <option value="">payee</option>
                        </select>
                        <select class="split-category-select">
                            <option value="">category</option>
                            ${categoryGroups.map(group => `
                                <optgroup label="${escapeHtml(group.name)}">
                                    ${group.categories.map(cat => `
                                        <option value="${cat.id}">${escapeHtml(group.name)}:${escapeHtml(cat.name)}</option>
                                    `).join('')}
                                </optgroup>
                            `).join('')}
                        </select>
                        <input type="text" class="split-memo-input" placeholder="memo" />
                        <input type="number" class="split-outflow-input" placeholder="outflow" step="0.01" />
                        <input type="number" class="split-inflow-input" placeholder="inflow" step="0.01" />
                    </div>
                    <div class="split-row">
                        <select class="split-payee-select">
                            <option value="">payee</option>
                        </select>
                        <select class="split-category-select">
                            <option value="">category</option>
                            ${categoryGroups.map(group => `
                                <optgroup label="${escapeHtml(group.name)}">
                                    ${group.categories.map(cat => `
                                        <option value="${cat.id}">${escapeHtml(group.name)}:${escapeHtml(cat.name)}</option>
                                    `).join('')}
                                </optgroup>
                            `).join('')}
                        </select>
                        <input type="text" class="split-memo-input" placeholder="memo" />
                        <input type="number" class="split-outflow-input" placeholder="outflow" step="0.01" />
                        <input type="number" class="split-inflow-input" placeholder="inflow" step="0.01" />
                    </div>
                `;
            }

            overlay.innerHTML = `
                <div class="split-modal" onclick="event.stopPropagation()">
                    <div class="split-modal-header">
                        <h3>Split Transaction</h3>
                        <div class="split-total">Total: $${(Math.abs(txn.amount) / 1000).toFixed(2)}</div>
                    </div>
                    <div class="split-modal-body" id="splitModalBody">
                        ${splitRowsHTML}
                        <button class="add-split-button" onclick="addSplitRow()">Add another split</button>
                    </div>
                    <div class="split-modal-footer">
                        <div class="split-remaining">
                            <span class="split-remaining-label">Amount remaining to assign:</span>
                            <div class="split-remaining-amounts">
                                <span id="splitRemainingOutflow">${(Math.abs(txn.amount) / 1000).toFixed(2)}</span>
                                <span id="splitRemainingInflow">0.00</span>
                            </div>
                        </div>
                        <div class="split-modal-actions">
                            <button class="split-cancel-button" onclick="closeSplitModal()">Cancel</button>
                            <button class="split-save-button" onclick="saveSplitTransaction(${index})">Save</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Store total amounts as data attributes
            const totalAmount = Math.abs(txn.amount) / 1000;
            overlay.setAttribute('data-total-outflow', txn.amount < 0 ? totalAmount : 0);
            overlay.setAttribute('data-total-inflow', txn.amount > 0 ? totalAmount : 0);

            // Add event listeners to all split input fields
            document.querySelectorAll('.split-outflow-input, .split-inflow-input').forEach(input => {
                input.addEventListener('input', updateSplitRemaining);
            });

            // Trigger initial calculation of remaining amount
            updateSplitRemaining();
        }

        // Close Split modal
        function closeSplitModal() {
            const overlay = document.getElementById('splitModalOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Add split row
        function addSplitRow() {
            const modalBody = document.getElementById('splitModalBody');
            const newRow = document.createElement('div');
            newRow.className = 'split-row';
            newRow.innerHTML = `
                <select class="split-payee-select">
                    <option value="">payee</option>
                </select>
                <select class="split-category-select">
                    <option value="">category</option>
                    ${categoryGroups.map(group => `
                        <optgroup label="${escapeHtml(group.name)}">
                            ${group.categories.map(cat => `
                                <option value="${cat.id}">${escapeHtml(group.name)}:${escapeHtml(cat.name)}</option>
                            `).join('')}
                        </optgroup>
                    `).join('')}
                </select>
                <input type="text" class="split-memo-input" placeholder="memo" />
                <input type="number" class="split-outflow-input" placeholder="outflow" step="0.01" />
                <input type="number" class="split-inflow-input" placeholder="inflow" step="0.01" />
            `;
            modalBody.insertBefore(newRow, modalBody.querySelector('.add-split-button'));

            // Add event listeners to the new inputs
            newRow.querySelectorAll('.split-outflow-input, .split-inflow-input').forEach(input => {
                input.addEventListener('input', updateSplitRemaining);
            });
        }

        // Calculate and update split remaining amounts
        function updateSplitRemaining() {
            const modal = document.getElementById('splitModalOverlay');
            if (!modal) return;

            const totalOutflow = parseFloat(modal.getAttribute('data-total-outflow')) || 0;
            const totalInflow = parseFloat(modal.getAttribute('data-total-inflow')) || 0;

            // Calculate sum of all split rows
            let outflowSum = 0;
            let inflowSum = 0;

            document.querySelectorAll('.split-row').forEach(row => {
                const outflow = parseFloat(row.querySelector('.split-outflow-input').value) || 0;
                const inflow = parseFloat(row.querySelector('.split-inflow-input').value) || 0;
                outflowSum += outflow;
                inflowSum += inflow;
            });

            // Calculate remaining amounts
            const remainingOutflow = totalOutflow - outflowSum;
            const remainingInflow = totalInflow - inflowSum;

            // Update display
            document.getElementById('splitRemainingOutflow').textContent = remainingOutflow.toFixed(2);
            document.getElementById('splitRemainingInflow').textContent = remainingInflow.toFixed(2);
        }

        // Save split transaction
        function saveSplitTransaction(index) {
            // Mark as split transaction
            filteredTransactions[index].category_name = 'Split (Multiple Categories...)';
            filteredTransactions[index].is_split = true;
            renderTransactions();
            updateStats();
            closeSplitModal();
        }

        // Update transaction category (legacy - kept for compatibility)
        function updateCategory(index, categoryId) {
            filteredTransactions[index].category_id = categoryId;
            updateStats();
        }

        // Toggle transaction selection
        function toggleTransaction(index) {
            filteredTransactions[index].selected = !filteredTransactions[index].selected;
            renderTransactions();
            updateStats();
        }

        // Toggle select all
        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            filteredTransactions.forEach(txn => txn.selected = checked);
            renderTransactions();
            updateStats();
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const uncategorizedOnly = document.getElementById('uncategorizedFilter').checked;

            // Start with account-filtered transactions
            applyAccountFilter();

            // Then apply search and uncategorized filters
            filteredTransactions = filteredTransactions.filter(txn => {
                const matchesSearch = !searchTerm || txn.payee_name.toLowerCase().includes(searchTerm);
                const matchesUncategorized = !uncategorizedOnly || !txn.category_id;
                return matchesSearch && matchesUncategorized;
            });

            if (currentSort) {
                applySortToFiltered(currentSort);
            }

            renderTransactions();
            updateStats();
        }

        // Apply sort
        function applySort() {
            const sortValue = document.getElementById('sortSelect').value;
            if (!sortValue) return;
            
            currentSort = sortValue;
            applySortToFiltered(sortValue);
            renderTransactions();
        }

        // Sort by column header click
        let currentSortField = null;
        let currentSortDirection = 'asc';

        function sortBy(field) {
            // Toggle direction if clicking same field, otherwise default to asc
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }

            // Sort the filtered transactions
            filteredTransactions.sort((a, b) => {
                let valA = a[field] || '';
                let valB = b[field] || '';

                // Handle dates
                if (field === 'date') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                }

                // Handle strings (case-insensitive)
                if (typeof valA === 'string' && typeof valB === 'string') {
                    const comparison = valA.toLowerCase().localeCompare(valB.toLowerCase());
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                }

                // Handle numbers
                const comparison = valA < valB ? -1 : valA > valB ? 1 : 0;
                return currentSortDirection === 'asc' ? comparison : -comparison;
            });

            // Update visual indicators
            updateSortIndicators(field, currentSortDirection);

            // Re-render
            renderTransactions();
        }

        function updateSortIndicators(field, direction) {
            // Remove all sort classes
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            // Add class to current sorted column
            const fieldMap = {
                'date': 0,
                'account_name': 1,
                'payee_name': 2,
                'memo': 3,
                'category_name': 4,
                'amount': 5
            };
            const index = fieldMap[field];
            if (index !== undefined) {
                const headers = document.querySelectorAll('th.sortable');
                if (headers[index]) {
                    headers[index].classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            }
        }

        // Sort filtered transactions (used by dropdown)
        function applySortToFiltered(sortValue) {
            const [field, direction] = sortValue.split('-');
            const multiplier = direction === 'asc' ? 1 : -1;

            filteredTransactions.sort((a, b) => {
                let valA = a[field] || '';
                let valB = b[field] || '';

                if (field === 'date') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                }

                if (typeof valA === 'string' && typeof valB === 'string') {
                    return multiplier * valA.toLowerCase().localeCompare(valB.toLowerCase());
                }

                return multiplier * (valA - valB);
            });
        }

        // Submit tagged transactions
        async function submitTransactions() {
            // Include transactions with category_id OR transfers (SKIP_TRANSFER)
            const selectedTxns = filteredTransactions.filter(txn =>
                txn.selected && (txn.category_id || txn.category_name === 'SKIP_TRANSFER')
            );

            if (selectedTxns.length === 0) {
                showMessage('Please select transactions to submit', 'error');
                return;
            }

            if (!budgetId) {
                showMessage('Budget ID not available. Please reload transactions.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                // Map tier to categorization_tier (1=sop, 2=historical, 3=research)
                const tierMap = { 'sop': 1, 'historical': 2, 'research': 3, 'amazon': 1 };

                const payload = {
                    budget_id: budgetId,
                    transactions: selectedTxns.map(txn => {
                        const isTransfer = txn.category_name === 'SKIP_TRANSFER';
                        return {
                            transaction_id: txn.id,
                            category_id: isTransfer ? null : txn.category_id,  // null for transfers
                            category_name: txn.category_name || 'Unknown',
                            categorization_tier: tierMap[txn.tier] || 3,
                            confidence_score: txn.confidence || 0.0,
                            method: txn.method || 'manual',
                            memo: txn.memo || null  // Include memo if present
                        };
                    })
                };

                console.log('Submitting payload:', JSON.stringify(payload, null, 2));
                console.log('budgetId value:', budgetId);

                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);

                if (result.status === 'error') {
                    throw new Error(result.message);
                }

                // Show detailed success message
                const msg = `Processed ${result.succeeded || selectedTxns.length} transactions successfully`;
                showMessage(msg, 'success');
                console.log('Success:', msg);

                // Remove submitted transactions
                filteredTransactions = filteredTransactions.filter(txn => !txn.selected || !txn.category_id);
                transactions = transactions.filter(txn => !txn.selected || !txn.category_id);

                renderTransactions();
                updateStats();

            } catch (error) {
                showMessage(`Error submitting: ${error.message}`, 'error');
                console.error('Submit error:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Tagged';
            }
        }

        // Update statistics
        function updateStats() {
            const total = filteredTransactions.length;
            const categorized = filteredTransactions.filter(txn => txn.category_id).length;
            const selected = filteredTransactions.filter(txn => txn.selected).length;
            
            document.getElementById('statsText').textContent = 
                `${total} transactions | ${categorized} categorized | ${selected} selected`;
        }

        // Format date
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Format currency
        function formatCurrency(amount) {
            const formatted = Math.abs(amount / 1000).toFixed(2);
            return amount >= 0 ? `$${formatted}` : `-$${formatted}`;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            
            if (e.key === 'l' && e.ctrlKey) {
                e.preventDefault();
                loadTransactions();
            } else if (e.key === 's' && e.ctrlKey) {
                e.preventDefault();
                submitTransactions();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('YNAB Transaction Tagger initialized');
        });
    </script>
</body>
</html>
